@{
    ViewBag.Title = "Chat";
}

<div class="page-wrapper stormy-theme toggled">
    <a id="show-sidebar" class="btn btn-sm btn-dark" href="#">
        <i class="fas fa-bars"></i>
    </a>
    <nav id="sidebar" class="sidebar-wrapper">
        <div class="sidebar-content">
            <div class="sidebar-brand">
                <a href="#">@ViewBag.Servername</a>
                <div id="close-sidebar">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="sidebar-header">
                <div class="user-pic">
                    <img class="img-responsive img-rounded" style="height:70px; height: 70px" src="https://raw.githubusercontent.com/azouaoui-med/pro-sidebar-template/gh-pages/bootstrap4/assets/img/user.jpg" alt="User picture">
                </div>
                <div class="user-info">

                    <span class="user-name">
                        @ViewBag.Username
                    </span>
                    <span class="user-status">
                        <i class="fa fa-circle"></i>
                        <span>Online</span>
                    </span>
                    <br>
                    <span class="user-role">
                        LooserUser
                    </span>

                    <span class="logout-link">
                        <a href="@Url.Action("Logout", "Home")">Logout</a>
                    </span>
                </div>
            </div>
            <!-- sidebar-header  -->
            <div class="status-change">
                <div>

                </div>
            </div>
            <!-- sidebar-search  -->
            <div class="sidebar-menu">
                <ul>
                    <li class="header-menu">
                        <span>Communication</span>
                    </li>
                    <li class="sidebar-dropdown">
                        <a href="#">
                            <i class="fas fa-comment-alt"></i>
                            <span>Chat channels</span>
                            <!--<span class="badge badge-pill badge-danger">New</span>-->
                        </a>
                        <div class="sidebar-submenu">
                        </div>
                    </li>
                    <li>
                        <a href="#">
                            <i class="far fa-envelope"></i>
                            <span>Private messages</span>
                            <span class="badge badge-pill badge-primary">3</span>
                        </a>
                    </li>
                    <li class="sidebar-dropdown">
                        <a href="#">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                        <div class="sidebar-submenu">
                            <ul>
                                <li>
                                    <a href="#">General</a>
                                </li>
                                <li>
                                    <a href="#">Change password</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li class="header-menu">
                        <span>Tools</span>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fa fa-calendar"></i>
                            <span>Calendar</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Tasks dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fas fa-image"></i>
                            <span>Gallery</span>
                        </a>
                    </li>
                </ul>
                <ul id="onlineusers" class="onlineusers">
                    <li class="header-menu">
                        <span>Online Users</span>
                    </li>
                </ul>
            </div>
            <!-- sidebar-menu  -->
        </div>
    </nav>
    <!-- sidebar-wrapper  -->

    <main class="page-content">
        <div class="container-fluid">
            <div id="chats">
                <input type="hidden" id="nickname" />
                <div id="chatarea" class="room">
                    <div class="room-name">#general</div>
                    <div class="messages" id="chatlog">
                    </div>
                    <div class="message-input row" style="position:relative">
                        <input type="text" id="message" class="col-md-11" spellcheck="true" autofocus placeholder="Write your message..." />
                        <button class="submit btn btn-send col-md-1" id="btn-send"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

@section scripts {
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.3.0.min.js"></script>

    <script src="~/Content/js/sidebar.js" type="text/javascript"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script>
        /*
        $(function () {
            var chat = $.connection.chatHub;
            chat.client.addNewMessageToPage = function (name, message) {
                $('#discussion').append('<ul style="list-style-type:square"><li><strong style="color:red;font-style:normal;font-size:medium;text-transform:uppercase">' + htmlEncode(name) + '  ' + '<strong style="color:black;font-style:normal;font-size:medium;text-transform:lowercase">said</strong>'
                    + '</strong>: ' + '<strong style="color:blue;font-style:oblique;font-size:medium">' + htmlEncode(message) + '</strong>' + '</li></ul>');
            };
            $('#message').focus();
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    chat.server.send($('#displayname').val(), $('#message').val());
                    $('#message').val('').focus();
                });
            });
        });
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }*/

        $(function () {
            startChatHub();
        });

        function startChatHub() {
            var chat = $.connection.chatHub;
            var username = "@ViewBag.Username";
            var currentDate = new Date();
            var currentTime = currentDate.getHours() + ":"
                + currentDate.getMinutes() + ":"
                + currentDate.getSeconds();

            $('#nickname').val(username);

            $.connection.hub.start().done(function () {
                chat.server.notify($('#nickname').val(), $.connection.hub.id);
            });

            chat.client.online = function (name) {
                if (name == $('#nickname').val()) {
                    $('#onlineusers').append('<li class="online-user you">You: ' + name + '</li>');
                }
                else {
                    $('#onlineusers').append('<li class="online-user">' + name + '</li>');
                    $("#users").append('<option value="' + name + '">' + name + '</option>');
                }
            };
            chat.client.enters = function (name) {
                $('#chatlog').append('<div class="text-infos">' + name + ' joins the conversation</div>');
                $("#users").append('<option value="' + name + '">' + name + '</option>');
                $('#onlineusers').append('<li class="online-user">' + name + '</li>');
            };
            chat.client.broadcastMessage = function (name, message) {
                if (message != "") {
                    if (name == username) {
                        $('#chatlog').append('<div class="row px-4">' +
                            '<div class="container">' +
                            '<span class="username-right">' + name + '</span>' +
                            '<p class= "dark" >' + message + '<br><br> <span class="time-right small">' + currentTime +
                            '</span></p></div></div>');

                        var element = document.getElementById("chatlog");
                        element.scrollTop = element.scrollHeight - element.clientHeight;
                    }
                    else {
                        $('#chatlog').append('<div class="row px-4">' +
                            '<div class="container">' +
                            '<span class="username">' + name + '</span>' +
                            '<p class= "light" >' + message + '<br><br> <span class="time-left small">' + currentTime +
                            '</span></p></div></div>');
                    }
                    var element = document.getElementById("chatlog");
                    element.scrollTop = element.scrollHeight - element.clientHeight;
                }
            };

            $('#chatarea').find("input").on("keydown", function (e) {
                if (e.which == 13) {
                    //if ($("#users").val() == "All") {
                    chat.server.send($('#nickname').val(), $('#message').val());
                    /*}
                    else {
                        chat.server.sendToSpecific($('#nickname').val(), $('#message').val(), $("#users").val());
                    }*/
                    $('#message').val('').focus();
                }
            });

            chat.client.disconnected = function (name) {
                $('#chatlog').append('<div class="text-infos"' + name + ' leaves the conversation</div>');
                $('#onlineusers li').remove(":contains('" + name + "')");
                $("#users option").remove(":contains('" + name + "')");
            }
            $.connection.hub.start().done(function () {
                chat.server.notify($('#nickname').val(), $.connection.hub.id);
                $('#btn-send').click(function () {
                    //if ($("#users").val() == "All") {
                        chat.server.send($('#nickname').val(), $('#message').val());
                    /*}
                    else {
                        chat.server.sendToSpecific($('#nickname').val(), $('#message').val(), $("#users").val());
                    }*/
                    $('#message').val('').focus();
                });
            });
        }

    </script>
}   